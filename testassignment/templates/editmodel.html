{% extends "base.html" %}
{% load uni_form_tags %}

{% block body_id %}edit-page{% endblock %}

{% block js %}
  <script src="{{ STATIC_URL }}uni_form/uni-form.jquery.js" type="text/javascript"></script>
  <script src="{{ STATIC_URL }}js/jquery.form-2.95.min.js" type="text/javascript"></script>
  {# <script type="text/javascript" src="{% url views.javascript 't6_widgetsjquery' 'edit' %}"></script> #}
  {{ form.media }}
{% endblock %}

{% block docreadyjs %}
  $('.jqueryuidatepickerwidget').datepicker({ dateFormat: 'yy-mm-dd' });

  USE_JS_VALIDATION = true; {# fixme: add key to settings.py #}

  function log() {
    if(0) return;
    if(typeof console != 'undefined' && typeof console.log == 'function')
      console.log((new Date()).toLocaleTimeString(), arguments);
  }

  function is_valid_length(value) {
    if(typeof value == 'string')
      return value.length > 0;

    return false;

  }


  function validate(formData, form, options) {
    error_text = 'This field is required.';
    errors_num = 0;

    $(form).find(':text').each(function() { //! textarea skipped
      input = $(this);
      holder = input.parent();
      is_required = holder.children('.requiredField').length > 0;
      value = input.fieldValue()[0];

      if(is_required && !is_valid_length(value)) {
        holder.addClass('error');
        error_html = '<p id="error_0_'+ input.attr('id') +'" class="errorField">' + error_text + '</p>';
        holder.prepend(error_html);
        errors_num++;
      }


    });


    log('errors_num', errors_num);
    return errors_num;

  }

  function notify(msg, is_error, timeout) {
    log('notify:', msg, is_error, timeout);

    feedback = $('#feedback')

    if(is_error)
      feedback.addClass('error')
    else
      $('#feedback.error').removeClass('error')

    feedback.text(msg);
    feedback.fadeIn('slow');


    //default timeout is 3s
    if(!timeout) timeout = 3000.0;
    feedback.fadeOut(timeout);
  }

  $('#contact_form').ajaxForm({
    dataType: 'json',
    success: function(response) {
      log('response:', response);
      if(response && response.length && response[0].pk) {
        notify('Saved [pk='+ response[0].pk +']');


      } else {
        for (k in response) {
          fid = 'id_' + k;
          holder = $('#div_' + fid)
          holder.addClass('error');
          for (i in response[k]) {
            error_text = response[k][i]
            error_html = '<p id="error_'+ i +'_'+ fid +'" class="errorField">' + error_text + '</p>'
            holder.prepend(error_html);
          }
        }
        notify('Can not save', true);
      }
      //enable form
      $('#contact_form :input').attr('disabled', false);

    }, //success

    beforeSubmit: function(formData, form, options) {

      //hide error messages
      $('p.errorField').remove();
      $('div.ctrlHolder').removeClass('error');


      if(USE_JS_VALIDATION && validate(formData, form, options)) //if any error(s) do not submit
        return false;

      //disable form
      $('#contact_form :input').attr('disabled', true);

    } //beforeSubmit


  }); //ajaxForm

{% endblock %}

{% block head_bottom %}
<link rel="stylesheet" href="{{ STATIC_URL }}uni_form/uni-form.css" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}uni_form/default.uni-form.css" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/edit.css" />
{% endblock %}


{% block title %}42 Coffee Cups Test Assignment: Edit{% endblock %}
{% block content_title %}<h2>42 Coffee Cups Test Assignment</h2>{% endblock %}
{% block content %}
<div id="feedback"></div>
{% uni_form form form.helper %}

{% endblock %}
